<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chemistry Sokoban</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" shrink-to-fit="no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/scss" th:href="@{/styles/style.scss}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<style>
    canvas {
        background: black;
    }
</style>
<!-- border:1px solid #d3d3d3;
        background-color: #f1f1f1; -->
<body onload="init();" >
<header class="showcase">
    <div class="container-fluid p-5 bg-primary text-white text-center">
        <h1>Chemistry Sokoban Game</h1>
        <p>Help the scientist put the reactants in their designated place in order to start an experiment</p>
        <p>Use arrow keys to move the scientist around</p>
        <p>Push reactants onto red tiles </p>
    </div>
    <div class="container mt-3">
        <canvas width="300" height="300" id="game"></canvas>
        <div class="row">
            <div class="col-sm-4">
                <a class="btn">Play Now</a>
            </div>
            <div class="col-sm-4">
                <a href="/chemistry_sources" class="btn">Read More</a>
            </div>
        </div>
    </div>
</header>

<script>
    var canvas;
    var context;

    var scientist;
    var reactant;
    var ball;

    var dots;
    var reactant_x;
    var reactant_y;

    var leftDirection = false;
    var rightDirection = true;
    var upDirection = false;
    var downDirection = false;
    var inGame = true;

    const DOT_SIZE = 10;
    const ALL_DOTS = 900;
    const MAX_RAND = 29;
    const DELAY = 140;
    const C_HEIGHT = 300;
    const C_WIDTH = 300;

    const LEFT_KEY = 37;
    const RIGHT_KEY = 39;
    const UP_KEY = 38;
    const DOWN_KEY = 40;

    var x = new Array(ALL_DOTS);
    var y = new Array(ALL_DOTS);

    function init() {
        canvas = document.getElementById('game');
        context = canvas.getContext('2d');

        loadImages();
        createSnake();
        locateReactant();
        setTimeout("gameCycle()", DELAY);
    }

    function loadImages() {
        scientist = new Image();
        scientist.src = "/images/scientist.png";

        ball = new Image();
        ball.src = "/images/beaker1.png";

        reactant = new Image();
        reactant.src = "/images/beaker2.png";
    }

    function createSnake() {
        dots = 3;

        for (var z = 0; z < dots; z++) {
            x[z] = 50-z*10;
            y[z] = 50;
        }
    }

    function checkReactant() {
        if ((x[0] == reactant_x) && (y[0] == reactant_y)) {
            dots++;
            locateReactant();
        }
    }

    function doDrawing() {
        context.clearRect(0, 0, C_WIDTH, C_HEIGHT);

        if (inGame) {
            context.drawImage(reactant, reactant_x, reactant_y);

            for (var z = 0; z < dots; z++) {

                if (z == 0) {
                    context.drawImage(scientist, x[z], y[z]);
                }
                else {
                    context.drawImage(ball, x[z], y[z]);
                }
            }
        }
        else {
            gameOver();
        }
    }

    function gameOver() {
        context.fillStyle = 'white';
        context.textBaseline = 'middle';
        context.textAlign = 'center';
        context.font = 'normal bold 18px serif';

        context.fillText('Game over', C_WIDTH/2, C_HEIGHT/2);
    }

    function move() {
        for (var z = dots; z > 0; z--) {
            x[z] = x[(z-1)];
            y[z] = y[(z-1)];
        }

        if (leftDirection) {
            x[0] -= DOT_SIZE;
        }

        if (rightDirection) {
            x[0] += DOT_SIZE;
        }

        if (upDirection) {
            y[0] -= DOT_SIZE;
        }

        if (downDirection) {
            y[0] += DOT_SIZE;
        }
    }

    function checkCollision() {
        for (var z = dots; z > 0; z--) {
            if ((z > 4) && (x[0] == x[z]) && (y[0] == y[z])) {
                inGame = false;
            }
        }

        if (y[0] >= C_HEIGHT) {
            inGame = false;
        }

        if (y[0] < 0) {
            inGame = false;
        }

        if (x[0] >= C_WIDTH) {
            inGame = false;
        }

        if (x[0] < 0) {
            inGame = false;
        }
    }

    function locateReactant() {
        var r = Math.floor(Math.random() * MAX_RAND);
        reactant_x = r * DOT_SIZE;

        r = Math.floor(Math.random() * MAX_RAND);
        reactant_y = r * DOT_SIZE;
    }

    function gameCycle() {
        if (inGame) {
            checkReactant();
            checkCollision();
            move();
            doDrawing();
            setTimeout("gameCycle()", DELAY);
        }
    }

    onkeydown = function(e) {
        var key = e.keyCode;

        if ((key == LEFT_KEY) && (!rightDirection)) {

            leftDirection = true;
            upDirection = false;
            downDirection = false;
        }

        if ((key == RIGHT_KEY) && (!leftDirection)) {

            rightDirection = true;
            upDirection = false;
            downDirection = false;
        }

        if ((key == UP_KEY) && (!downDirection)) {

            upDirection = true;
            rightDirection = false;
            leftDirection = false;
        }

        if ((key == DOWN_KEY) && (!upDirection)) {

            downDirection = true;
            rightDirection = false;
            leftDirection = false;
        }
    };

</script>

</body>
</html>